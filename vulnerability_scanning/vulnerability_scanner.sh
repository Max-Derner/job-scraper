#! /bin/bash

# Fetch shared variables
source vulnerability_scanning/shared_variables.sh  # needs to be sourced to share variables

# Set up our directories
echo -e "\nEnsuring directory for outputs"
if [ ! -d "$OUTPUT_SUBDIR" ]; then  # "if not directory called..."
    echo "No output directory: ${OUTPUT_SUBDIR} :: creating..."
    mkdir -p "$OUTPUT_SUBDIR" && echo -e "Success!"
fi

# Produce the SBOM
echo -e "\nProducing SBOM for: $TARGET_DIR..."
if syft dir:"$TARGET_DIR"  -o json >  "$SBOM_FILE_PATH"; then
    echo -e "Success! SBOM is now in: $SBOM_FILE_PATH"
    # Scan SBOM for vulnerabilities
    echo -e "\nScanning SBOM for vulnerabilities..."
    if grype sbom:"$SBOM_FILE_PATH" -o json > "$VULN_FILE_PATH"; then
        echo -e "Success! Vulnerabilites now in JSON format in: ${VULN_FILE_PATH}"
        # Produce tabular output from json object
        source vulnerability_scanning/vulnerability_tabular_formatter.sh  # needs to be sourced to share variables
    else
        echo "There was a problem producing vulnerabilities JSON"
    fi
else
    echo "There was a problem with creating the SBOM, skipping vulnerability scanning..."
fi