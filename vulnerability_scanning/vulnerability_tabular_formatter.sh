#! /bin/bash

CONDENSED_VULNERABILITIES=$(jq -c '.matches, .ignoredMatches | .[] | {"CVE": (.vulnerability.id), "link": (.vulnerability.dataSource), "severity": (.vulnerability.severity), "language": (.artifact.language), "package": (.artifact.name), "type": (.artifact.type), "installed": (.artifact.version), "fixed": (.vulnerability.fix.versions | .[]) }' < vulnerability_outputs/2023-07-04#09:02:54/job_scraper_vulnerablilties.json)


draw_table() {
    # Give table headers
    printf '%-23s' "¦ CVE Number"
    printf '%-18s' "¦ Severity Level"
    printf '%-15s' "¦ Language"
    printf '%-35s' "¦ Package"
    printf '%-20s' "¦ Installed"
    printf '%-20s' "¦ Fixed In"
    printf '%s\n' "¦ Data Source"

    for COND_VULN in $1; do
        CVE=$(echo "$COND_VULN" | jq -r '.CVE' )
        SEVERITY=$(echo "$COND_VULN" | jq -r '.severity' )
        LANGUAGE=$(echo "$COND_VULN" | jq -r '.language' )
        PACKAGE=$(echo "$COND_VULN" | jq -r '.package' )
        INSTALLED=$(echo "$COND_VULN" | jq -r '.installed' )
        FIXED_IN=$(echo "$COND_VULN" | jq -r '.fixed' )
        LINK=$(echo "$COND_VULN" | jq -r '.link' )
        printf '%-23s' "¦ $CVE"
        printf '%-18s' "¦ $SEVERITY"
        printf '%-15s' "¦ $LANGUAGE"
        printf '%-35s' "¦ $PACKAGE"
        printf '%-20s' "¦ $INSTALLED"
        printf '%-20s' "¦ $FIXED_IN"
        printf '%s\n'  "¦ $LINK"
    done
}

echo -e "\nConstructing tabular output..."
TABLE=$(draw_table "$CONDENSED_VULNERABILITIES")
echo "$TABLE"

echo "$TABLE">"$VULN_TABLE_FILE_PATH"
echo "Table also available in $VULN_TABLE_FILE_PATH"